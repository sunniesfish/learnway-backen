<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ìƒë‹´ì‚¬ ë§ˆì´í˜ì´ì§€</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            display: flex;
            min-height: 100vh;
            margin: 0;
        }

        #sidebar {
            width: 250px;
            background-color: #343a40;
            color: white;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            position: fixed;
        }

        #sidebar .consultantIMG {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
        }

        #sidebar .sidebar-header {
            padding: 10px 15px;
            font-size: 1.2em;
            text-align: center;
        }

        #sidebar .sidebar-item {
            padding: 10px 15px;
            width: 100%;
            text-align: center;
        }
        
        /* ----------------ë©”ëª¨ì¥----------------- */
        
        #sidebarMemo {
		    width: 250px;
		    background-color: #343a40;
		    color: white;
		    padding-top: 20px;
		    display: flex;
		    flex-direction: column;
		    height: 100vh;
		}
		
		#sidebarMemo .sidebar-header {
		    padding: 10px 15px;
		    font-size: 1.2em;
		}
        
        #sidebarMemo .sidebar-itemDropdown {
		    padding: 10px 15px;
		    cursor: pointer;
		}
		
		#sidebarMemo .sidebar-itemDropdown:hover {
		    background-color: #495057;
		}
        
        #sidebarMemo .submenuDropdown {
		    display: none;
		    padding-left: 25px;
		}
		
		#sidebarMemo .submenuDropdown a {
		    color: #adb5bd;
		    text-decoration: none;
		    display: block;
		    padding: 5px 0;
		}
		
		#sidebarMemo .submenuDropdown a:hover {
		    color: white;
		}

		/* ----------------ë©”ëª¨ì¥ ë----------------- */
		
        #sidebar #logout {
            margin-top: auto;
            margin-bottom: 20px;

        }

        .content {
            margin-left: 250px;
            padding: 20px;
            flex: 1;
        }

        .room-list {
            margin-top: 20px;
        }

        .disabled-link {
            pointer-events: none;
            color: gray;
        }

        .toast-container {
            position: fixed;
            background-color: bisque;
            top: 20px;
            right: 20px;
            z-index: 1060;
        }
    </style>
</head>
<body>
    <div id="sidebar">
		<div class="sidebar-header">
            <span>ğŸš€ LearnWay</span>
        </div>
        <hr>
        <img src="" alt="í”„ë¡œí•„ ì‚¬ì§„" class="consultantIMG">
        <div class="sidebar-header">
            <span id="loginCon">ğŸ‘¤ íšŒì›ë‹˜</span>
        </div>
        <div class="sidebar-item">
            <span id="subject">ë‹´ë‹¹ ë¶„ì•¼</span>
        </div>
        
        <div class="sidebar-item">
            <span id="description">ìƒë‹´ì‚¬ ì†Œê°œ</span>
        </div>
        <hr>
        <div id="sidebarMemo">
	    <div class="sidebar-itemDropdown">
            ğŸ“ ë©”ëª¨ì¥
	        <div class="submenuDropdown">
                <a href="#" class="MemoAdd-link">ë©”ëª¨ë“±ë¡</a>
                <a href="#" class="MemoList-link">ë©”ëª¨ë¦¬ìŠ¤íŠ¸</a>
            </div>
	    </div>
	
        </div>
        <button id="logout" name="logout" class="btn btn-outline-danger" >ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div class="content">
        <input type="hidden" th:value="${counselor_id}" id="counselor_id">
        <div class="container">
            <h1>ìƒë‹´ì‚¬ ë§ˆì´í˜ì´ì§€</h1>
            <h2>ReservationList</h2>
            <table class="table table-striped room-list">
                <thead>
                    <tr>
                        <th>ì˜ˆì•½ ID</th>
                        <th>ì˜ˆì•½ì</th>
                        <th>ì˜ˆì•½ ì‹œê°„</th>
                        <th>ìƒë‹´ìì •ë³´</th>
                        <th>í™”ìƒ ìƒë‹´</th>
                    </tr>
                </thead>
                <tbody id="reservationList">
                    <!-- ì˜ˆì•½ ë¦¬ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                </tbody>
            </table>
        </div>

        <!-- ìœ ì € ì •ë³´ ëª¨ë‹¬ -->
        <div class="modal fade" id="userInfoModal" tabindex="-1" role="dialog" aria-labelledby="userInfoModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userInfoModalLabel">ìœ ì € ì •ë³´</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- ìœ ì € ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
                        <div id="userInfoContent"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-success" id="printButton">í”„ë¦°íŠ¸</button>
                        <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">ë‹«ê¸°</button>
                    </div>
                </div>
            </div>
        </div>

        <div aria-live="polite" aria-atomic="true" style="position: relative; min-height: 200px;">
            <div style="position: absolute; top: 0; right: 0;">
                <div id="toastContainer" class="toast-container"></div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
			
			$('.sidebar-itemDropdown').click(function() {
            	$(this).find('.submenuDropdown').slideToggle(300);
            });
			
            // íˆë“  inputì˜ value ê°’ì„ ë³€ìˆ˜ì— ì €ì¥
            var counselor_id = document.getElementById("counselor_id").value;

            // SSE ì—°ê²°
            var eventSource = new EventSource('/sse/subscribe/' + counselor_id);
            eventSource.addEventListener('notification', function(event) {
                console.log("ì•Œë¦¼ ë“¤ì–´ì˜´: ", event.data);
                showToast('ìƒˆ ì•Œë¦¼', event.data);
            });

            eventSource.onerror = function(event) {
                console.error('SSE ì—°ê²° ì˜¤ë¥˜', event);
            };

            // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
            function showToast(title, message) {
                var toastId = 'toast-' + new Date().getTime();
                var toastHtml =
                    `<div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-autohide="false">
                        <div class="toast-header">
                            <strong class="mr-auto">${title}</strong>
                            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="toast-body">
                            ${message}
                            <div class="row">
                                <div class="col-md-12">
                                    <button class="btn btn-sm btn-outline-success mt-2 float-right confirm-btn">í™•ì¸</button>
                                </div>
                            </div>                  
                        </div>
                    </div>`;

                $('#toastContainer').append(toastHtml);
                var $toast = $('#' + toastId);
                $toast.toast('show');

                // í™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì²˜ë¦¬
                $toast.find('.confirm-btn').click(function() {
                    $toast.toast('hide'); // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                    location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                });
            }

            // ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜
            function formatDateTime(dateTimeString) {
                const date = new Date(dateTimeString);
                const year = date.getFullYear();
                const month = ('0' + (date.getMonth() + 1)).slice(-2);
                const day = ('0' + date.getDate()).slice(-2);
                let hours = date.getHours();
                const minutes = ('0' + date.getMinutes()).slice(-2);

                // ì˜¤ì „/ì˜¤í›„ êµ¬ë¶„ê³¼ 12ì‹œê°„ì œ í‘œì‹œ
                const period = hours < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
                hours = hours % 12 || 12; // 0ì‹œì¼ ê²½ìš° 12ì‹œë¡œ í‘œì‹œ
                const formattedTime = `${year}/${month}/${day} ${period} ${hours}:${minutes}`;

                return formattedTime;
            }

            // ì˜ˆì•½ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
            function fetchReservations() {
                $.ajax({
                    url: '/api/reservations?consultant=' + counselor_id,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        var reservationList = $('#reservationList');
                        reservationList.empty();
                        
                        // ë°ì´í„°ë¥¼ ì‹œì‘ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
                        data.sort(function(a, b) {
                            return new Date(a.bookingStart) - new Date(b.bookingStart);
                        });

                        const currentTime = new Date(); // í˜„ì¬ ì‹œê°„

                        data.forEach(function(reservation) {
                            // ì˜ˆì•½ ì‹œê°„ì„ í¬ë§·íŒ…
                            var bookingStartTime = new Date(reservation.bookingStart);
                            var bookingEndTime = new Date(reservation.bookingEnd);
                            var formattedStartTime = formatDateTime(reservation.bookingStart);
                            var formattedEndTime = formatDateTime(reservation.bookingEnd);
                            var formattedTime = `${formattedStartTime} ~ ${formattedEndTime}`;
                            var userName = reservation.member.memberName;
                            var roomId = counselor_id;
                            var userId = reservation.member.id;
                            console.log("userId : " + userId)

                            // í˜„ì¬ ì‹œê°„ì´ ì˜ˆì•½ ì‹œê°„ ë‚´ì— ìˆëŠ”ì§€ í™•ì¸
                            var isWithinBookingTime = currentTime >= bookingStartTime && currentTime <= bookingEndTime;
                            var linkClass = isWithinBookingTime ? '' : 'disabled-link';
                            var linkText = isWithinBookingTime ? 'ì…ì¥í•˜ê¸°' : 'ì…ì¥ë¶ˆê°€';

                            var row = `
                                <tr>
                                    <td>${reservation.member.memberId}</td>
                                    <td>${userName}</td>
                                    <td>${formattedTime}</td>
                                    <td><a href="#" class="user-info-link" data-user-id="${userId}">í™•ì¸</a></td>
                                    <td><a href="#" class="${linkClass} enter-room-link" data-room-id="${roomId}">${linkText}</a></td>
                                </tr>
                            `;
                            reservationList.append(row);
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('ì˜ˆì•½ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ', error);
                    }
                });
            }

            // ì…ì¥í•˜ê¸° ë§í¬ í´ë¦­ ì‹œì˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            $(document).on('click', 'a.enter-room-link', function(e) {
                e.preventDefault();
                var roomId = $(this).data('room-id');
                var myKey = Math.random().toString(36).substring(2, 11);
                // WebSocket ì—°ê²° ì„¤ì •
                var socket = new SockJS('/signaling/video');
                var stompClient = Stomp.over(socket);
                stompClient.debug = null;

                // ì„œë²„ì™€ì˜ WebSocket ì—°ê²°
                stompClient.connect({}, function () {
                    console.log('WebSocket ì—°ê²° ì„±ê³µ');

                    // ì„œë²„ë¡œ roomId ì „ì†¡
                    stompClient.send(`/app/join/room/${roomId}/${myKey}`, {}, JSON.stringify({}));

                    // ì„œë²„ë¡œë¶€í„°ì˜ ì‘ë‹µ ì²˜ë¦¬
                    stompClient.subscribe(`/topic/join/room/${roomId}/${myKey}`, function (response) {
                        var message = response.body.trim();
                        console.log('ì„œë²„ ì‘ë‹µ:', message);

                        // "successfully"ì™€ "full" ë¬¸ìì—´ì— ë”°ë¥¸ ì²˜ë¦¬
                        if (message === 'successfully') {
                            console.log("ë°© ë“¤ì–´ê°€ê¸° ìš”ì²­ ì„±ê³µ");
                            window.open(`http://localhost:8080/video?roomId=${roomId}`, '_blank');
                        } else if (message === 'full') {
                            console.log("ë°© ë“¤ì–´ê°€ê¸° ìš”ì²­ ì‹¤íŒ¨");
                            alert('ì´ë¯¸ ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.');
                        } else {
                            console.log("ì„œë²„ ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜:", message);
                            // í•„ìš”í•œ ì¶”ê°€ ì²˜ë¦¬ë¥¼ ì—¬ê¸°ì— ì¶”ê°€
                        }

                        // WebSocket ì—°ê²° ì¢…ë£Œ
                        stompClient.disconnect();
                    });
                }, function (error) {
                    console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
                });
            });

            // í™•ì¸í•˜ê¸° ë§í¬ í´ë¦­ ì‹œì˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            $(document).on('click', 'a.user-info-link', function(e) {
                e.preventDefault();
                var userId = $(this).data('user-id');

                // ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                $.ajax({
                    url: `/api/users/${userId}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(user) {
                        var userInfoContent = `
                            <p>ì´ë¦„: ${user.userName}</p>
                            <p>ë‚˜ì´: ${user.userAge}</p>
                            <p>ì„±ë³„: ${user.sex}</p>
                            <p>ì„±ì í†µê³„: ${user.stats}</p>
                            <p>ëª©í‘œëŒ€í•™: ${user.targetUniversity}</p>
                            <p>ëª©í‘œí•™ê³¼: ${user.targetSubject}</p>
                            <p>ì´ë©”ì¼: ${user.userEmail}</p>
                        `;
                        $('#userInfoContent').html(userInfoContent);

                        // ëª¨ë‹¬ ë„ìš°ê¸°
                        $('#userInfoModal').modal('show');
                    },
                    error: function(xhr, status, error) {
                        console.error('ìœ ì € ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ', error);
                    }
                });
            });

            // ì´ˆê¸° ì˜ˆì•½ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ í˜¸ì¶œ
            fetchReservations();

            // í”„ë¦°íŠ¸ ë²„íŠ¼ í´ë¦­ ì‹œì˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            $(document).on('click', '#printButton', function() {
                var printContents = $('#userInfoContent').html();

                // í”„ë¦°íŠ¸ ì‹¤í–‰ ì „ì— ëª¨ë‹¬ì„ ë‹«ìŠµë‹ˆë‹¤.
                $('#userInfoModal').modal('hide');
                var originalContents = $('body').html();
                $('body').html(printContents);
                window.print();
                $('body').html(originalContents);
                // í”„ë¦°íŠ¸ í›„ì— ì˜ˆì•½ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ ë° ëª¨ë‹¬ ì—´ê¸°
                fetchReservations();
                // í”„ë¦°íŠ¸ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                window.location.reload();
            });
        });
    </script>
    <script src="/js/consult/sidebarConsultantInfo.js"></script><!-- ì‚¬ì´ë“œë°” ìƒë‹´ì‚¬ ì •ë³´ì¡°íšŒ javascript -->
</body>
</html>
