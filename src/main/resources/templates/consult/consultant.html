 <!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>LearnWay</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            display: flex;
            min-height: 100vh;
            margin: 0;
        }
        #sidebar {
            width: 300px;
            background-color: #343a40;
            color: white;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            position: fixed;
        }

        #sidebar .consultantIMG {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
        }

        #sidebar .sidebar-header {
            padding: 10px 15px;
            font-size: 1.2em;
            text-align: center;
        }

        #sidebar .sidebar-item {
            padding: 10px 15px;
            width: 100%;
            text-align: center;
        }
        
        /* ----------------ë©”ëª¨ì¥----------------- */
        
        #sidebarMemo {
		    width: 250px;
		    background-color: #343a40;
		    color: white;
		    padding-top: 20px;
		    display: flex;
		    flex-direction: column;
		    height: 100vh;
		}
		
		#sidebarMemo .sidebar-header {
		    padding: 10px 15px;
		    font-size: 1.2em;
		}
        
        #sidebarMemo .sidebar-itemDropdown {
		    padding: 10px 15px;
		    font-size: 1.2em;
		    cursor: pointer;
		}
		
		#sidebarMemo .sidebar-itemDropdown:hover {
		    background-color: #495057;
		}
        
        #sidebarMemo .submenuDropdown {
		    display: none;
		    padding-left: 25px;
		}
		
		#sidebarMemo .submenuDropdown a {
		    color: #adb5bd;
		    text-decoration: none;
		    display: block;
		    padding: 5px 0;
		}
		
		#sidebarMemo .submenuDropdown a:hover {
		    color: white;
		}

		/* ----------------ë©”ëª¨ì¥ ë----------------- */
		
        #sidebar #logout {
            margin-top: auto;
            margin-bottom: 20px;

        }
        
        #sidebar #editProfile {
            margin-top: auto;
            margin-bottom: 20px;
		}
		
		/* ë²„íŠ¼ ê·¸ë£¹ì„ ìˆ˜í‰ìœ¼ë¡œ ì •ë ¬ */
		#sidebar .button-group {
		    display: flex;
		    flex-direction: row;
		    justify-content: space-around; /* ë²„íŠ¼ë“¤ ì‚¬ì´ì˜ ì—¬ë°±ì„ ê· ë“±í•˜ê²Œ ì„¤ì • */
		    align-items: center; /* ì„¸ë¡œ ì •ë ¬ì„ ê°€ìš´ë°ë¡œ ì¡°ì • */
		    margin-top: 20px; /* ìœ„ìª½ ì—¬ë°± ì¶”ê°€ */
		    margin-bottom: 20px; /* ì•„ë˜ìª½ ì—¬ë°± ì¶”ê°€ */
		}
		
		/* ê° ë²„íŠ¼ì˜ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
		#editProfile, #logout {
		    width: auto; /* ë²„íŠ¼ ë„ˆë¹„ ìë™ ì„¤ì • */
		    min-width: 120px; /* ìµœì†Œ ë„ˆë¹„ ì„¤ì • */
		    padding: 10px 20px; /* ë²„íŠ¼ ë‚´ë¶€ ì—¬ë°± ì„¤ì • */
		    margin: 0 10px; /* ë²„íŠ¼ ì‚¬ì´ì˜ ê°€ë¡œ ì—¬ë°± ì„¤ì • */
		    font-weight: 500; /* í°íŠ¸ ë‘ê»ê²Œ ì„¤ì • */
		    font-size: 14px; /* í°íŠ¸ í¬ê¸° ì„¤ì • */
		}
		/* a íƒœê·¸ ê´€ë ¨ CSS */
		a{
			text-decoration: none;
		}
		a:hover{
		  text-decoration: none;
		  color:inherit;
		  cursor: pointer;
		}
		
		.content {
		    margin-left: 250px;
		    padding: 20px;
		    flex: 1;
		    margin-top: 30px; /* ì—¬ê¸°ì— ì›í•˜ëŠ” ì—¬ë°± ê°’ì„ ì¶”ê°€ */
		}

        .room-list {
            margin-top: 20px;
        }

        .disabled-link {
            pointer-events: none;
            color: gray;
        }

        .toast-container {
            position: fixed;
            background-color: bisque;
            top: 20px;
            right: 20px;
            z-index: 1060;
        }
        
        #memoEditContent {
	        width: 450px; /* ì›í•˜ëŠ” ë„ˆë¹„ë¡œ ì„¤ì • */
	        height: 300px; /* ì›í•˜ëŠ” ë†’ì´ë¡œ ì„¤ì • */
	    }
	    
	    
		.memo-grid-container {
		    display: grid;
		    grid-template-columns: repeat(3, 1fr); /* 3ê°œì˜ ì—´ì„ ê°€ì§„ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ì„¤ì • */
		    gap: 20px; /* ê·¸ë¦¬ë“œ ì•„ì´í…œ ì‚¬ì´ì˜ ê°„ê²© ì„¤ì • */
		    padding: 20px; /* ë‚´ë¶€ ì—¬ë°± ì„¤ì • */
		}
		
		.memo-item {
		    position: relative; /* ìƒëŒ€ì  ìœ„ì¹˜ ì§€ì • */
		    width: calc(100% / 3 - 40px); /* ëª¨ë‹¬ ì°½ ë„ˆë¹„ì— ë§ê²Œ 3ê°œì”© ë°°ì—´ë  ë„ˆë¹„ ì„¤ì • */
		    min-width: 200px; /* ìµœì†Œ ë„ˆë¹„ ì„¤ì • (ì„ íƒì‚¬í•­) */
		    height: 150px; /* ë„¤ëª¨ ëª¨ì–‘ì˜ ê³ ì •ëœ ì„¸ë¡œ í¬ê¸° ì„¤ì • */
		    background-color: #ffffff; /* ë°°ê²½ìƒ‰ ì§€ì • */
		    padding: 20px; /* ë‚´ë¶€ ì—¬ë°± ì„¤ì • */
		    border: 1px solid #e0e0e0; /* í…Œë‘ë¦¬ ì„¤ì • */
		    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); /* ê·¸ë¦¼ì íš¨ê³¼ ì¶”ê°€ */
		    border-radius: 5px; /* í…Œë‘ë¦¬ ë‘¥ê¸€ê¸° ì„¤ì • */
		    overflow: hidden; /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ìˆ¨ê¸°ê¸° */
		    text-overflow: ellipsis; /* í…ìŠ¤íŠ¸ê°€ ë„˜ì¹  ê²½ìš° ìƒëµ ë¶€í˜¸(...)ë¡œ í‘œì‹œ */
		    transition: all 0.3s ease; /* í˜¸ë²„ íš¨ê³¼ì— ì• ë‹ˆë©”ì´ì…˜ì„ ì¶”ê°€í•  ê²½ìš° ì‚¬ìš© */
		}
		
		.memo-icon {
		    position: absolute; /* ì ˆëŒ€ì  ìœ„ì¹˜ ì§€ì • */
		    top: 10px; /* ì¹´ë“œì˜ ìƒë‹¨ì—ì„œ 10px ë–¨ì–´ì§„ ìœ„ì¹˜ */
		    left: 10px; /* ì¹´ë“œì˜ ì™¼ìª½ì—ì„œ 10px ë–¨ì–´ì§„ ìœ„ì¹˜ */
		    font-size: 1.5rem; /* ì´ëª¨ì§€ í¬ê¸° ì„¤ì • */
		    pointer-events: none; /* ì´ëª¨ì§€ê°€ í´ë¦­ë˜ì§€ ì•Šë„ë¡ ì„¤ì • */
		}
		
		.memo-item:hover {
		    background-color: #f0f0f0; /* í˜¸ë²„ ì‹œ ë°°ê²½ìƒ‰ ë³€ê²½ */
		    box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); /* í˜¸ë²„ ì‹œ ê·¸ë¦¼ì íš¨ê³¼ ë³€ê²½ */
		}
    </style>
</head>
<body>
    <div id="sidebar">
		<div class="sidebar-header">
            <img src="/img/mainLogo.png" style="width:200px; height:auto;">
        </div>
        <hr>
        <!--<img src="" alt="í”„ë¡œí•„ ì‚¬ì§„" class="consultantIMG">-->
        <img th:src="@{${#authentication.principal.image}}" alt="User Image" class="consultantIMG" onerror="this.onerror=null;this.src='/img/member/member-default.png';">
        <div class="sidebar-header">
        </div>
        <div class="sidebar-item">
            <span id="subject">ë‹´ë‹¹ ë¶„ì•¼</span>
        </div>
        
        <div class="sidebar-item">
            <span id="description">ìƒë‹´ì‚¬ ì†Œê°œ</span>
        </div>
        <hr>
        <div id="sidebarMemo">
	    <div class="sidebar-itemDropdown">
            ğŸ“ ë©”ëª¨ì¥
	        <div class="submenuDropdown">
                <a href="#" class="MemoAdd-link">ë©”ëª¨ë“±ë¡</a>
                <a href="#" class="MemoList-link">ë©”ëª¨ë¦¬ìŠ¤íŠ¸</a>
            </div>
	    </div>
	
        </div>
        <div class="button-group">
	        <a th:href="@{/consult/update/{id}(id=${counselor_id})}" id="editProfile" class="btn btn-outline-success">ì •ë³´ìˆ˜ì •</a>
	        <form method="post" action="/logout">
                <button type="submit" id="logout" name="logout" class="btn btn-outline-danger" >ë¡œê·¸ì•„ì›ƒ</button>
            </form>
        </div>
    </div>

    <div class="content">
        <input type="hidden" th:value="${counselor_id}" id="counselor_id">
        <input type="hidden" th:value="${connectId}" id="connectId">
        <div class="container">
            <h1><span id="titleName"></span></h1>
            <br/>
            <h2>ReservationList</h2>
            <br/>
            <table class="table table-striped room-list">
                <thead>
                    <tr>
                        <th>â„¹ï¸ ì˜ˆì•½ ID</th>
                        <th>ğŸ‘¤ ì˜ˆì•½ì</th>
                        <th>â° ì˜ˆì•½ ì‹œê°„</th>
                        <th>ğŸ“‹ ì‹ ì²­ì ì •ë³´</th>
                        <th>ğŸ’» í™”ìƒ ìƒë‹´</th>
                    </tr>
                </thead>
                <tbody id="reservationList">
                    <!-- ì˜ˆì•½ ë¦¬ìŠ¤íŠ¸ -->
                </tbody>
            </table>
        </div>

        <!-- ìœ ì € ì •ë³´ ëª¨ë‹¬ -->
        <div class="modal fade" id="userInfoModal" tabindex="-1" role="dialog" aria-labelledby="userInfoModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userInfoModalLabel">ìœ ì € ì •ë³´</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- ìœ ì € ì •ë³´ ë””í…Œì¼ -->
                        <div id="userInfoContent"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-success" id="printButton">í”„ë¦°íŠ¸</button>
                      <!--  <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">ë‹«ê¸°</button> -->
                    </div>
                </div>
            </div>
        </div>
		<!-- ì•Œë¦¼ê¸°ëŠ¥ -->
        <div aria-live="polite" aria-atomic="true" style="position: relative; min-height: 200px;">
            <div style="position: absolute; top: 0; right: 0;">
                <div id="toastContainer" class="toast-container"></div>
            </div>
        </div>
    </div>
    <!-- ì•Œë¦¼ ì†Œë¦¬ -->
  	<audio id="notification-sound" src="/audio/notification.mp3" preload="auto"></audio>
    
    <!-- ë©”ëª¨ë“±ë¡ ëª¨ë‹¬ -->
    <div class="modal fade" id="memoAddModal" tabindex="-1" role="dialog" aria-labelledby="memoAddModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="memoAddModalLabel" style="font-weight: bold;" >ğŸ“ ë©”ëª¨ ë“±ë¡</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="memoAddForm">
                        <div class="form-group">
                            <label for="memoTitle" style="font-weight: bold;" >ğŸ“Œ ì œëª©</label>
                            <input type="text" class="form-control" id="memoTitle" name="title" required>
                        </div>
                        <div class="form-group">
                            <label for="memoContent" style="font-weight: bold;" >ğŸ–Š ë‚´ìš©</label>
                            <textarea class="form-control" id="memoContent" name="content" rows="5" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-outline-success float-right insertBtn">ì €ì¥</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
	<!-- ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ -->
	<div class="modal fade" id="memoListModal" tabindex="-1" role="dialog" aria-labelledby="memoListModalLabel" aria-hidden="true">
	    <div class="modal-dialog modal-lg" role="document">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="memoListModalLabel" style="font-weight: bold;" >ğŸ“ ë©”ëª¨ ë¦¬ìŠ¤íŠ¸</h5>
	                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                    <span aria-hidden="true">&times;</span>
	                </button>
	            </div>
	            <div class="modal-body">
	                <div class="memo-grid-container" id="memoListContainer">
	                    <!-- ì—¬ê¸°ì— ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ -->
	                </div>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">ë‹«ê¸°</button>
	            </div>
	        </div>
	    </div>
	</div>
	<!-- ë©”ëª¨ ë””í…Œì¼ ë° ìˆ˜ì • í¼ì„ í¬í•¨í•œ ëª¨ë‹¬ -->
	<div id="memoDetailModal" class="modal fade" tabindex="-1" role="dialog">
	    <div class="modal-dialog" role="document">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title">ğŸ“ ë©”ëª¨ë‚´ìš© ë° ìˆ˜ì •</h5>
	                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                    <span aria-hidden="true">&times;</span>
	                </button>
	            </div>
	            <div class="modal-body">
	                <!-- ë©”ëª¨ ë””í…Œì¼ ë‚´ìš© -->
	                <div id="memoDetailContent">
	                    <!-- í´ë¦­ëœ ë©”ëª¨ì˜ ë””í…Œì¼ ë‚´ìš©ì´ ì—¬ê¸°ì— ë“¤ì–´ê° -->
	                </div>
	
	                <!-- ë©”ëª¨ ìˆ˜ì • í¼ -->
	                <form id="memoEditForm">
	                    <div class="form-group">
	                        <label for="memoEditTitle" style="font-weight: bold;" >ğŸ“Œ ì œëª©</label>
	                        <input type="text" class="form-control" id="memoEditTitle" required>
	                    </div>
	                    <div class="form-group">
	                        <label for="memoEditContent" style="font-weight: bold;">ğŸ–Š ë‚´ìš©</label>
	                        <textarea class="form-control" id="memoEditContent" rows="3" required></textarea>
	                    </div>
					    <div class="text-right">
					        <button type="submit" class="btn btn-outline-success" id="updateMemoBtn">ìˆ˜ì •</button>
					        <button type="button" class="btn btn-outline-danger" id="deleteMemoBtn">ì‚­ì œ</button>
					    </div>
	                </form>
	            </div>
	        </div>
	    </div>
	</div>
<script>
        $(document).ready(function() {
            // ë©”ëª¨ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ëª¨ë“±ë¡ ëª¨ë‹¬ ë„ìš°ê¸°
            $('.MemoAdd-link').click(function(e) {
                e.preventDefault();
                $('#memoAddModal').modal('show');
            });

            // ë©”ëª¨ë“±ë¡ í¼ ì œì¶œ ì‹œ ì²˜ë¦¬
            $('#memoAddForm').submit(function(e) {
                e.preventDefault();
                var memoData = {
                    memoTitle: $('#memoTitle').val(),
                    memoContents: $('#memoContent').val(),
                };

                $.ajax({
                    url: '/api/memos',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(memoData),
                    success: function(response) {
                        alert('ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        $('#memoAddModal').modal('hide');
                        $('#memoAddForm')[0].reset(); // í¼ ë¦¬ì…‹
                    },
                    error: function(xhr, status, error) {
                        console.error('ë©”ëª¨ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ', error);
                        alert('ë©”ëª¨ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            });
            
			// ë©”ëª¨ë¦¬ìŠ¤íŠ¸ í´ë¦­ í•¨ìˆ˜
			$('.MemoList-link').click(function(e) {
			    e.preventDefault();
			    
			    $.ajax({
			        url: '/api/memos',
			        type: 'GET',
			        dataType: 'json',
			        success: function(data) {
			            var memoList = $('#memoListContainer');
			            memoList.empty(); // ê¸°ì¡´ ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
			            
			            // ê° ë©”ëª¨ë¥¼ ë°˜ë³µí•´ì„œ í‘œì‹œ
			            data.forEach(function(memo) {
			                var formattedDateTime = new Date(memo.timestamp).toLocaleString(); // ë©”ëª¨ ì‘ì„± ì¼ì‹œ í¬ë§·íŒ…
			                
			                var memoItem = `
			                    <div class="card mb-3 memo-item" data-memo-id="${memo.memoId}">
			                        <div class="card-body">
										<span class="memo-icon">ğŸ–Š</span> <!-- ğŸ–Š ì´ëª¨ì§€ -->
			                            <h5 class="card-title">${memo.memoTitle}</h5>
			                            <p class="card-text">${memo.memoContents}</p>
			                        </div>
			                    </div>
			                `;
			                
			                memoList.append(memoItem); // ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
			            });
			            
			            $('#memoListModal').modal('show'); // ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ í‘œì‹œ
			        },
			        error: function(xhr, status, error) {
			            console.error('ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜:', error);
			            alert('ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
			        }
			    });
			});
			
		    // ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë©”ëª¨ í•­ëª© í´ë¦­ ì‹œ ì²˜ë¦¬
		    $(document).on('click', '.memo-item', function() {
		        var memoId = $(this).data('memo-id');
		
		        // í•´ë‹¹ ë©”ëª¨ì˜ ë””í…Œì¼(ìˆ˜ì •í¼) ì •ë³´ ê°€ì ¸ì˜¤ê¸°
		        $.ajax({
		            url: '/api/memos/' + memoId,
		            type: 'GET',
		            dataType: 'json',
		            success: function(memo) {
		                if (Array.isArray(memo)) {
		                    memo = memo[0];
		                }
		
		                // ìˆ˜ì • í¼ì— ê¸°ì¡´ ë©”ëª¨ ë‚´ìš© ì±„ìš°ê¸°
		                $('#memoEditTitle').val(memo.memoTitle);
		                $('#memoEditContent').val(memo.memoContents);
		
		                // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì²˜ë¦¬
		                $('#deleteMemoBtn').off('click').on('click', function() {
		                    if (confirm('ì •ë§ ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
		                        deleteMemo(memoId);
		                    }
		                });
		
		                // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ì²˜ë¦¬
		                $('#updateMemoBtn').off('click').on('click', function() {
		                    var updatedTitle = $('#memoEditTitle').val();
		                    var updatedContent = $('#memoEditContent').val();
		
		                    // ë©”ëª¨ ì—…ë°ì´íŠ¸
		                    $.ajax({
		                        url: '/api/memos/' + memoId,
		                        type: 'PUT',
		                        contentType: 'application/json',
		                        data: JSON.stringify({
		                            memoTitle: updatedTitle,
		                            memoContents: updatedContent
		                        }),
		                        success: function(response) {
		                            alert('ë©”ëª¨ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
		                            $('#memoDetailModal').modal('hide');
		                        },
		                        error: function(xhr, status, error) {
		                            console.error('ë©”ëª¨ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜:', error);
		                            alert('ë©”ëª¨ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
		                        }
		                    });
		                });
		
		                // ëª¨ë‹¬ ì—´ê¸°
		                $('#memoDetailModal').modal('show');
		            },
		            error: function(xhr, status, error) {
		                console.error('ë©”ëª¨ ë””í…Œì¼ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜:', error);
		                alert('ë©”ëª¨ ë””í…Œì¼ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
		            }
		        });
		    });
		
		    // ë©”ëª¨ ì‚­ì œ ìš”ì²­ ì²˜ë¦¬
		    function deleteMemo(memoId) {
		        $.ajax({
		            url: '/api/memos/' + memoId,
		            type: 'DELETE',
		            success: function(response) {
		                alert('ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
		                $('#memoDetailModal').modal('hide');
		                $('.memo-item[data-memo-id="' + memoId + '"]').remove();
		            },
		            error: function(xhr, status, error) {
		                console.error('ë©”ëª¨ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ', error);
		                alert('ë©”ëª¨ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
		            }
		        });
		    }


            $('.sidebar-itemDropdown').click(function() {
                $(this).find('.submenuDropdown').slideToggle(300);
            });

            var counselor_id = document.getElementById("counselor_id").value;

            var eventSource = new EventSource('/sse/subscribe/' + counselor_id);
            eventSource.addEventListener('notification', function(event) {
                console.log("ì•Œë¦¼ ë“¤ì–´ì˜´: ", event.data);
                showToast('ìƒˆ ì•Œë¦¼', event.data);
                
            // ì•Œë¦¼ ì†Œë¦¬ ì¬ìƒ
        	document.getElementById('notification-sound').play();
        	
            });

            eventSource.onerror = function(event) {
                console.error('SSE ì—°ê²° ì˜¤ë¥˜', event);
            };

            function showToast(title, message) {
                var toastId = 'toast-' + new Date().getTime();
                var toastHtml =
                    `<div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-autohide="false">
                        <div class="toast-header">
                            <strong class="mr-auto">${title}</strong>
                            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="toast-body">
                            ${message}
                            <div class="row">
                                <div class="col-md-12">
                                    <button class="btn btn-sm btn-outline-success mt-2 float-right confirm-btn">í™•ì¸</button>
                                </div>
                            </div>                  
                        </div>
                    </div>`;

                $('#toastContainer').append(toastHtml);
                var $toast = $('#' + toastId);
                $toast.toast('show');

                $toast.find('.confirm-btn').click(function() {
                    $toast.toast('hide');
                    location.reload();
                });
            }

            function formatDateTime(dateTimeString) {
                const date = new Date(dateTimeString);
                const year = date.getFullYear();
                const month = ('0' + (date.getMonth() + 1)).slice(-2);
                const day = ('0' + date.getDate()).slice(-2);
                let hours = date.getHours();
                const minutes = ('0' + date.getMinutes()).slice(-2);

                const period = hours < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
                hours = hours % 12 || 12;
                const formattedTime = `${year}/${month}/${day} ${period} ${hours}:${minutes}`;

                return formattedTime;
            }

            function fetchReservations() {
                $.ajax({
                    url: '/api/reservations?consultant=' + counselor_id,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        var reservationList = $('#reservationList');
                        reservationList.empty();
                        
                        data.sort(function(a, b) {
                            return new Date(a.bookingStart) - new Date(b.bookingStart);
                        });

                        const currentTime = new Date();// í˜„ì¬ ì‹œê°„

                        data.forEach(function(reservation) {
							// ì˜ˆì•½ ì‹œê°„ì„ í¬ë§·íŒ…
                            var bookingStartTime = new Date(reservation.bookingStart);
                            var bookingEndTime = new Date(reservation.bookingEnd);
                            var formattedStartTime = formatDateTime(reservation.bookingStart);
                            var formattedEndTime = formatDateTime(reservation.bookingEnd);
                            var formattedTime = `${formattedStartTime} ~ ${formattedEndTime}`;
                            var userName = reservation.member.memberName;
                            var roomId = reservation.counselor.id;
                            var userId = reservation.member.id;
                            var consultantId = reservation.counselor.consultantId;
			
							 // í˜„ì¬ ì‹œê°„ì´ ì˜ˆì•½ ì‹œê°„ ë‚´ì— ìˆëŠ”ì§€ í™•ì¸
                            var isWithinBookingTime = currentTime >= bookingStartTime && currentTime <= bookingEndTime;
                            var linkClass = isWithinBookingTime ? '' : 'disabled-link';
                            //var linkClass = isWithinBookingTime ? 'disabled-link' : '';
                            var linkText = isWithinBookingTime ? 'ğŸ’» ì…ì¥í•˜ê¸°' : 'ğŸš« ì…ì¥ë¶ˆê°€';

                            var row = `
                                <tr>
                                    <td>${reservation.member.memberId}</td>
                                    <td>${userName}</td>
                                    <td>${formattedTime}</td>
                                    <td><a href="#" class="user-info-link" data-user-id="${userId}">ğŸ“ ì •ë³´í™•ì¸</a></td>
                                    <td><a href="#" class="${linkClass} enter-room-link" data-room-id="${roomId}" data-consultant-id="${consultantId}" >${linkText}</a></td>
                                </tr>
                            `;
                            reservationList.append(row);
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('ì˜ˆì•½ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ', error);
                    }
                });
            }

			// ì…ì¥í•˜ê¸° ë§í¬ í´ë¦­ ì‹œì˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            $(document).on('click', 'a.enter-room-link', function(e) {
                e.preventDefault();
                var roomId = $(this).data('room-id');
                var myKey = $(this).data('consultant-id');
                console.log("myKey : "+myKey);
                // WebSocket ì—°ê²° ì„¤ì •
                //var socket = new SockJS('http://localhost:8095/signaling/video');
                //var socket = new SockJS('https://192.168.219.105:443/signaling/video');
				var socket = new SockJS('https://43.202.58.56:443/signaling/video');//aws í…ŒìŠ¤íŠ¸
				var stompClient = Stomp.over(socket);
				
				stompClient.connect({}, function (frame) {
				    console.log('Connected: ' + frame);
				    stompClient.subscribe('/topic/messages', function (message) {
				        console.log(message.body);
				    });
				}, function (error) {
				    console.error('Error: ' + error);
				});
                

                
                stompClient.debug = null;
				
				// ì„œë²„ì™€ì˜ WebSocket ì—°ê²°
                stompClient.connect({}, function () {
                    console.log('WebSocket ì—°ê²° ì„±ê³µ');
					
					// ì„œë²„ë¡œ roomId ì „ì†¡
                    stompClient.send(`/app/join/room/${roomId}/${myKey}`, {}, JSON.stringify({}));

					// ì„œë²„ë¡œë¶€í„°ì˜ ì‘ë‹µ ì²˜ë¦¬
                    stompClient.subscribe(`/topic/join/room/${roomId}/${myKey}`, function (response) {
                        var message = response.body.trim();
                        console.log('ì„œë²„ ì‘ë‹µ:', message);

						//ì„œë²„ë‹¨ì—ì„œ ë°©ì¸ì›ìˆ˜ì²´í¬ ë¡œì§ ëŒì•„ê°€ê¸° (í˜„ì¬ ìˆ˜ì •í•„ìš”í•œë¶€ë¶„ ë°©ì„ êº¼ë²„ë ¸ì„ë•Œ ì¸ì›ìˆ˜ê°€ ë§µì— ê³„ì† ë‚¨ì•„ìˆëŠ”í˜„ìƒ)
                        if (message === 'successfully') {
                            console.log("ë°© ë“¤ì–´ê°€ê¸° ìš”ì²­ ì„±ê³µ");
                            //window.open(`http://localhost:8095/video?roomId=${roomId}`, '_blank');
                            //window.open(`https://192.168.219.105:443/consult/video?roomId=${roomId}`, '_blank');
                            window.open(`https://43.202.58.56:443/consult/video?roomId=${roomId}`, '_blank');//aws í…ŒìŠ¤íŠ¸
                        } else if (message === 'full') {
                            console.log("ë°© ë“¤ì–´ê°€ê¸° ìš”ì²­ ì‹¤íŒ¨");
                            alert('ì´ë¯¸ ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.');
                        } else {
                            console.log("ì„œë²„ ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜:", message);
                        }
						// WebSocket ì—°ê²° ì¢…ë£Œ
                        stompClient.disconnect();
                    });
                }, function (error) {
                    console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
                });
            });
            
			// ìœ ì €ì •ë³´ í™•ì¸í•˜ê¸° ë§í¬ í´ë¦­ ì‹œì˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            $(document).on('click', 'a.user-info-link', function(e) {
                e.preventDefault();
                var userId = $(this).data('user-id');
				
				//ìœ ì € ì •ë³´ê°€ì ¸ì˜¤ê¸°ìœ„í•œ ìš”ì²­(ì™ ì§€ ë‹¤ë¥¸ì‚¬ëŒê³¼ ì¤‘ë³µë ìˆ˜ìˆëŠ”ë¶€ë¶„ì´ê¸°ì— ì ê²€í•´ë´ì•¼í• ë“¯? )
                $.ajax({
                    url: `/api/users/${userId}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(user) {
                        var userInfoContent = `
                            <p><img src="${user.memberImg}" alt="User Image" style="max-width: 100%; height: auto;"></p>
                            <p>ì´ë¦„: ${user.memberName}</p>
                            <p>ë‚˜ì´:  ${user.memberAge} ì„¸</p>
                            <p>ì„±ë³„: ${user.memberGender}</p>
                            <p>ì—°ë½ì²˜: ${user.memberPhone}</p>
                            <p>Email: ${user.memberEmail}</p>
                            <p>ì£¼ì†Œ: ${user.memberAllAddress}</p>
                            <p>${user.memberSchool} í•™êµ ${user.memberGrade} í•™ë…„</p>
                            <p>ìƒë‹´ìš”ì²­ë‚´ìš©: ${user.requestContents}</p>
                        `;
                        $('#userInfoContent').html(userInfoContent);
                        
                        // ëª¨ë‹¬ ë„ìš°ê¸°
                        $('#userInfoModal').modal('show');
                    },
                    error: function(xhr, status, error) {
                        console.error('ìœ ì € ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ', error);
                    }
                });
            });
            
            // ì •ë³´ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ
		    $('#editProfile').click(function() {
		        window.location.href = '#'; // ìˆ˜ì • í˜ì´ì§€ì˜ URLë¡œ ë³€ê²½
		    });
			
			//í”„ë¦°íŠ¸ í•¨ìˆ˜
            $('#printButton').click(function() {
                var printContent = $('#userInfoContent').html();
                var originalContent = $('body').html();

                $('body').html(printContent);
                window.print();
                $('body').html(originalContent);
                location.reload();
            });
            
			// ì´ˆê¸° ì˜ˆì•½ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ í˜¸ì¶œ
            fetchReservations();
            setInterval(fetchReservations, 300000); // 5ë¶„ë§ˆë‹¤ ì˜ˆì•½ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
        });
    </script>
    <script src="/js/consult/sidebarConsultantInfo.js"></script><!-- ì‚¬ì´ë“œë°” ìƒë‹´ì‚¬ ì •ë³´ì¡°íšŒ javascript -->
</body>
</html>
